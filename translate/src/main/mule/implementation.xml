<?xml version="1.0" encoding="UTF-8"?>

<mule
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<flow
		name="translateEngToSpan"
		doc:id="95b17ca1-77cf-4706-ad86-8f27fda85473">
		<http:listener doc:name="Listener" doc:id="143b0074-d22e-4e34-a39c-0c662df9a560" config-ref="HTTP_Listener_config" path="/translate" allowedMethods="POST" />
		<http:request
			method="POST"
			doc:name="Call NLP Cloud Translate API - Convert English to Spanish"
			doc:id="a70b17f6-4983-44f4-accb-7b5341e0e897"
			url="${nlp.url}" targetValue="#[output application/json --- read(payload, &quot;application/json&quot;).'translation_text']" target="translatedText">
			<http:body><![CDATA[#[{
	"text":payload.'messageToTranslate',
	"source":"eng_Latn",
	"target":"spa_Latn"
}]]]></http:body>
			<http:headers><![CDATA[#[output text/plain
---
{
	"Authorization" : "Token " ++ p("secure::nlp.apiKey"),
	"Content-Type" : "application/json"
}]]]></http:headers>
		</http:request>
		<http:request
			method="POST"
			doc:name="Call ChatGPT API - Convert Spanish to English"
			doc:id="9bed9a40-faa5-41f7-91a5-f866677ffddc"
			url="${chatGPT.url}">
			<http:body><![CDATA[#[output application/json
---
{
 "model": "gpt-3.5-turbo",
 "messages": [{"role": "user", "content": "Translate " ++ vars.translatedText as String ++ " to English"}],
 "temperature": 0.7
}]]]></http:body>
			<http:headers><![CDATA[#[output text/plain
---
{
	"Authorization" : "Bearer " ++ p("secure::chatGPT.apiKey"),
	"Content-Type" : "application/json"
}]]]></http:headers>
		</http:request>
		<ee:transform doc:name="Transform Message" doc:id="3a925d3d-f2d5-42fd-8617-942af64d5b66" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"toSpanish-fromNLPCloudAPI": vars.translatedText,
	"backToEnglish-fromChatGPT": payload.choices[0].message.content as String replace "\n\n" with ""
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger
			level="INFO"
			doc:name="Logger"
			doc:id="2e711e45-3367-4b52-b469-f75aae7f7c44"
			message="#[payload]" />
	</flow>
</mule>
